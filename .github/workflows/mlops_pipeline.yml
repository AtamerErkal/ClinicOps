# .github/workflows/mlops_pipeline.yml - FINAL FIXED VERSION

name: KlinikOps MLOps Pipeline (CI/CD/DVC/ACI)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  RG_NAME: ClinicOps-RG
  LOCATION: westeurope
  STORAGE_ACCOUNT: clinicopsdvcstorage2025 
  CONTAINER_NAME: clinicops-dvc 
  
jobs:
  full-mlops-workflow:
    runs-on: ubuntu-latest
    outputs:
      run_id: ${{ steps.train.outputs.MLFLOW_RUN_ID }}
      
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install dvc[azure]
          pip install azure-storage-blob 

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # --- DVC PULL (FIXED) ---
      - name: DVC Pull Data
        env:
          # DVC will automatically detect and use these env vars for authentication
          AZURE_STORAGE_ACCOUNT: ${{ env.STORAGE_ACCOUNT }}
          AZURE_STORAGE_KEY: ${{ secrets.AZURE_STORAGE_KEY }} 
          AZURE_CONTAINER: ${{ env.CONTAINER_NAME }}
        run: |
          echo "Configuring DVC remote..."
          # Only set the URL. Auth is handled by the environment variables above.
          dvc remote add -d myremote azure://$AZURE_STORAGE_ACCOUNT/$AZURE_CONTAINER
          
          echo "Attempting DVC pull..."
          dvc pull -v --force
          ls -l data/raw/

      # --- TRAIN MODEL ---
      - name: Run Data Processing and Train Model
        id: train
        env:
          PYTHONPATH: .
        run: |
          echo "Starting Data Processing..."
          python scripts/data_processing.py
          
          echo "Starting Training..."
          # train.py uses local tracking and returns a Run ID
          RUN_ID=$(python scripts/train.py) 
          
          echo "MLFLOW_RUN_ID=$RUN_ID" >> $GITHUB_OUTPUT 

      # --- UPLOAD ARTIFACTS ---
      - name: Upload MLflow Artifacts to Azure Blob
        env:
          AZURE_STORAGE_KEY: ${{ secrets.AZURE_STORAGE_KEY }}
        run: |
          RUN_ID=${{ steps.train.outputs.MLFLOW_RUN_ID }}
          
          echo "Uploading artifacts for Run ID: $RUN_ID"
          
          # Upload local mlruns folder to Azure Blob
          az storage blob upload-batch \
            --source mlruns \
            --destination mlruns \
            --container-name $CONTAINER_NAME \
            --account-name $STORAGE_ACCOUNT \
            --account-key $AZURE_STORAGE_KEY \
            --overwrite
            
          echo "âœ… Artifacts uploaded."

      - name: Upload Pointer File
        env:
          AZURE_STORAGE_KEY: ${{ secrets.AZURE_STORAGE_KEY }}
        run: |
          # Upload the latest_run_id.txt so API knows which model to load
          az storage blob upload \
            --container-name $CONTAINER_NAME \
            --account-name $STORAGE_ACCOUNT \
            --account-key $AZURE_STORAGE_KEY \
            --file latest_run_id.txt \
            --name latest_model_run.txt \
            --overwrite
            
          echo "âœ… Pointer file uploaded."

  deploy-api-to-aci:
    needs: full-mlops-workflow
    runs-on: ubuntu-latest
    environment: Production 
    env:
      ACR_LOGIN_SERVER: ${{ secrets.AZURE_CR_LOGIN_SERVER }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      - name: Docker Login
        uses: docker/login-action@v3
        with:
          registry: ${{ env.ACR_LOGIN_SERVER }}
          username: ${{ secrets.AZURE_CR_USERNAME }}
          password: ${{ secrets.AZURE_CR_PASSWORD }}
      - name: Build/Push
        uses: docker/build-push-action@v5 
        with:
          context: .
          push: true
          tags: ${{ env.ACR_LOGIN_SERVER }}/klinikops-model:${{ github.sha }}
          
      - name: Deploy ACI
        env:
          # Explicitly map secrets to env vars for this step
          AZURE_STORAGE_KEY: ${{ secrets.AZURE_STORAGE_KEY }}
          RG_NAME: ${{ env.RG_NAME }}
          STORAGE_ACCOUNT: ${{ env.STORAGE_ACCOUNT }}
          ACR_LOGIN_SERVER: ${{ env.ACR_LOGIN_SERVER }}
          ACR_USERNAME: ${{ secrets.AZURE_CR_USERNAME }}
          ACR_PASSWORD: ${{ secrets.AZURE_CR_PASSWORD }}
        run: |
          SHA_SHORT=$(echo ${{ github.sha }} | cut -c1-8)
          ACI_NAME="ci-api-$SHA_SHORT" 
          IMAGE_NAME="$ACR_LOGIN_SERVER/klinikops-model:${{ github.sha }}"
          
          # Construct connection string for the API container
          CONN_STRING="DefaultEndpointsProtocol=https;AccountName=$STORAGE_ACCOUNT;AccountKey=$AZURE_STORAGE_KEY;EndpointSuffix=core.windows.net"

          echo "Deploying ACI..."
          
          az container create \
            --resource-group $RG_NAME \
            --name $ACI_NAME \
            --image $IMAGE_NAME \
            --location westeurope \
            --dns-name-label $ACI_NAME \
            --registry-login-server $ACR_LOGIN_SERVER \
            --registry-username $ACR_USERNAME \
            --registry-password $ACR_PASSWORD \
            --ports 80 \
            --cpu 1 \
            --memory 1.5 \
            --protocol TCP \
            --os-type Linux \
            --restart-policy Always \
            --environment-variables \
              AZURE_STORAGE_ACCOUNT="$STORAGE_ACCOUNT" \
              AZURE_STORAGE_KEY="$AZURE_STORAGE_KEY" \
              AZURE_STORAGE_CONNECTION_STRING="$CONN_STRING"
          
          echo "âœ… Deployment initiated."
          
          CONTAINER_IP=$(az container show \
            --resource-group $RG_NAME \
            --name $ACI_NAME \
            --query ipAddress.ip -o tsv)
          
          echo "=========================================="
          echo "ðŸŽ‰ Deployment Complete!"
          echo "Health Check: http://${CONTAINER_IP}/health"
          echo "=========================================="