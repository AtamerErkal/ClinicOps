# .github/workflows/mlops_pipeline.yml - SYNTAX ERROR FIXED

name: KlinikOps MLOps Pipeline (CI/CD/DVC/ACI)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

# Global environment variables are exported to the shell automatically
env:
  RG_NAME: ClinicOps-RG
  LOCATION: westeurope
  STORAGE_ACCOUNT: clinicopsdvcstorage2025 
  CONTAINER_NAME: clinicops-dvc 
  
jobs:
  full-mlops-workflow:
    runs-on: ubuntu-latest
    outputs:
      run_id: ${{ steps.train.outputs.MLFLOW_RUN_ID }}
      
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install dvc[azure]
          pip install azure-storage-blob 

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # --- DVC PULL ---
      - name: DVC Pull Data
        # FIX: We don't need to map env vars here. DVC reads $STORAGE_ACCOUNT if needed, 
        # but we use 'dvc remote modify' with the secret explicitly.
        run: |
          echo "Configuring DVC remote..."
          dvc remote add -d myremote azure://$STORAGE_ACCOUNT/$CONTAINER_NAME
          
          # Explicitly set the key for authentication
          dvc remote modify myremote azure_storage_key ${{ secrets.AZURE_STORAGE_KEY }}
          
          echo "Attempting DVC pull..."
          dvc pull -v --force
          ls -l data/raw/

      # --- TRAIN MODEL ---
      - name: Run Data Processing and Train Model
        id: train
        env:
          PYTHONPATH: .
          # Export secret key for Python scripts
          AZURE_STORAGE_KEY: ${{ secrets.AZURE_STORAGE_KEY }}
        run: |
          # Global env vars like STORAGE_ACCOUNT are available as shell vars
          export AZURE_STORAGE_ACCOUNT=$STORAGE_ACCOUNT
          
          echo "Starting Data Processing..."
          python scripts/data_processing.py
          
          echo "Starting Training..."
          RUN_ID=$(python scripts/train.py) 
          
          echo "MLFLOW_RUN_ID=$RUN_ID" >> $GITHUB_OUTPUT 

      # --- UPLOAD ARTIFACTS (FIXED SYNTAX) ---
      - name: Upload MLflow Artifacts to Azure Blob
        env:
          AZURE_STORAGE_KEY: ${{ secrets.AZURE_STORAGE_KEY }}
        run: |
          RUN_ID=${{ steps.train.outputs.MLFLOW_RUN_ID }}
          
          # FIX: Use shell variables ($STORAGE_ACCOUNT) instead of ${{ env... }} to avoid YAML parsing errors
          az storage blob upload-batch \
            --source mlruns \
            --destination mlruns \
            --container-name $CONTAINER_NAME \
            --account-name $STORAGE_ACCOUNT \
            --account-key $AZURE_STORAGE_KEY \
            --overwrite
            
          echo "âœ… Artifacts for $RUN_ID uploaded."

      - name: Upload latest_model_run.txt Pointer File
        env:
          AZURE_STORAGE_KEY: ${{ secrets.AZURE_STORAGE_KEY }}
        run: |
          az storage blob upload \
            --container-name $CONTAINER_NAME \
            --account-name $STORAGE_ACCOUNT \
            --account-key $AZURE_STORAGE_KEY \
            --file latest_run_id.txt \
            --name latest_model_run.txt \
            --overwrite
            
          echo "âœ… Pointer file uploaded."

  deploy-api-to-aci:
    needs: full-mlops-workflow
    runs-on: ubuntu-latest
    environment: Production 
    env:
      ACR_LOGIN_SERVER: ${{ secrets.AZURE_CR_LOGIN_SERVER }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      - name: Docker Login
        uses: docker/login-action@v3
        with:
          registry: ${{ env.ACR_LOGIN_SERVER }}
          username: ${{ secrets.AZURE_CR_USERNAME }}
          password: ${{ secrets.AZURE_CR_PASSWORD }}
      - name: Build/Push
        uses: docker/build-push-action@v5 
        with:
          context: .
          push: true
          tags: ${{ env.ACR_LOGIN_SERVER }}/klinikops-model:${{ github.sha }}
          
      - name: Deploy ACI (FIXED SYNTAX)
        env:
          AZURE_STORAGE_KEY: ${{ secrets.AZURE_STORAGE_KEY }}
        run: |
          SHA_SHORT=$(echo ${{ github.sha }} | cut -c1-8)
          ACI_NAME="ci-api-$SHA_SHORT" 
          IMAGE_NAME="$ACR_LOGIN_SERVER/klinikops-model:${{ github.sha }}"
          
          # Create connection string using shell variables
          CONN_STRING="DefaultEndpointsProtocol=https;AccountName=$STORAGE_ACCOUNT;AccountKey=$AZURE_STORAGE_KEY;EndpointSuffix=core.windows.net"

          echo "Deploying ACI..."
          
          # Pass variables explicitly to the container environment
          az container create \
            --resource-group $RG_NAME \
            --name $ACI_NAME \
            --image $IMAGE_NAME \
            --location $LOCATION \
            --dns-name-label $ACI_NAME \
            --registry-login-server $ACR_LOGIN_SERVER \
            --registry-username ${{ secrets.AZURE_CR_USERNAME }} \
            --registry-password ${{ secrets.AZURE_CR_PASSWORD }} \
            --ports 80 \
            --cpu 1 \
            --memory 1.5 \
            --protocol TCP \
            --os-type Linux \
            --restart-policy Always \
            --environment-variables \
              AZURE_STORAGE_ACCOUNT="$STORAGE_ACCOUNT" \
              AZURE_STORAGE_KEY="$AZURE_STORAGE_KEY" \
              AZURE_STORAGE_CONNECTION_STRING="$CONN_STRING"
          
          echo "âœ… Deployment initiated."
          
          # Get IP
          CONTAINER_IP=$(az container show \
            --resource-group $RG_NAME \
            --name $ACI_NAME \
            --query ipAddress.ip -o tsv)
          
          echo "=========================================="
          echo "ðŸŽ‰ Deployment Complete!"
          echo "Health Check: http://${CONTAINER_IP}/health"
          echo "=========================================="