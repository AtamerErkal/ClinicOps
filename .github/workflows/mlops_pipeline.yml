# .github/workflows/mlops_pipeline.yml - ARTIFACT UPLOAD RESTORED

name: KlinikOps MLOps Pipeline (CI/CD/DVC/ACI)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  RG_NAME: ClinicOps-RG
  LOCATION: westeurope
  STORAGE_ACCOUNT: clinicopsdvcstorage2025 
  CONTAINER_NAME: clinicops-dvc 
  
jobs:
  full-mlops-workflow:
    runs-on: ubuntu-latest
    outputs:
      run_id: ${{ steps.train.outputs.MLFLOW_RUN_ID }} # Output is used again
      
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install dvc[azure]
          pip install azure-storage-blob 

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: DVC Pull Data
        env:
          AZURE_STORAGE_ACCOUNT: ${{ env.STORAGE_ACCOUNT }}
          AZURE_STORAGE_KEY: ${{ secrets.AZURE_STORAGE_KEY }} 
        run: |
          dvc remote add -d myremote azure://${{ env.STORAGE_ACCOUNT }}/${{ env.CONTAINER_NAME }}
          echo "Attempting DVC pull..."
          dvc pull -v --force

      # --- TRAIN & CAPTURE RUN ID ---
      - name: Run Data Processing and Train Model
        id: train
        env:
          PYTHONPATH: .
        run: |
          python scripts/data_processing.py
          
          # Capture the Run ID
          RUN_ID=$(python scripts/train.py) 
          
          echo "Captured RUN_ID: $RUN_ID"
          echo "MLFLOW_RUN_ID=$RUN_ID" >> $GITHUB_OUTPUT 

      # --- UPLOAD ARTIFACTS TO AZURE (RESTORED) ---
      - name: Upload MLflow Artifacts to Azure Blob
        env:
          AZURE_STORAGE_ACCOUNT: ${{ env.STORAGE_ACCOUNT }}
          AZURE_STORAGE_KEY: ${{ secrets.AZURE_STORAGE_KEY }}
        run: |
          RUN_ID=${{ steps.train.outputs.MLFLOW_RUN_ID }}
          
          # Upload the local mlruns folder to Azure
          az storage blob upload-batch \
            --source mlruns \
            --destination mlruns \
            --container-name ${{ env.CONTAINER_NAME }} \
            --account-name ${{ env.STORAGE_ACCOUNT }} \
            --auth-mode key \
            --overwrite
            
          echo "✅ Artifacts for $RUN_ID uploaded."

      - name: Upload latest_model_run.txt Pointer File
        env:
          AZURE_STORAGE_ACCOUNT: ${{ env.STORAGE_ACCOUNT }}
          AZURE_STORAGE_KEY: ${{ secrets.AZURE_STORAGE_KEY }}
        run: |
          # Upload the file that tells API which Run ID to load
          az storage blob upload \
            --container-name ${{ env.CONTAINER_NAME }} \
            --account-name ${{ env.STORAGE_ACCOUNT }} \
            --file latest_run_id.txt \
            --name latest_model_run.txt \
            --auth-mode key \
            --overwrite
            
          echo "✅ Pointer file uploaded."

  deploy-api-to-aci:
    needs: full-mlops-workflow
    runs-on: ubuntu-latest
    environment: Production 
    env:
      ACR_LOGIN_SERVER: ${{ secrets.AZURE_CR_LOGIN_SERVER }}
      STORAGE_ACCOUNT: ${{ env.STORAGE_ACCOUNT }}
      CONTAINER_NAME: ${{ env.CONTAINER_NAME }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      - name: Docker Login
        uses: docker/login-action@v3
        with:
          registry: ${{ env.ACR_LOGIN_SERVER }}
          username: ${{ secrets.AZURE_CR_USERNAME }}
          password: ${{ secrets.AZURE_CR_PASSWORD }}
      - name: Build/Push
        uses: docker/build-push-action@v5 
        with:
          context: .
          push: true
          tags: ${{ env.ACR_LOGIN_SERVER }}/klinikops-model:${{ github.sha }}
          
      - name: Deploy ACI
        env:
          RG_NAME: ${{ env.RG_NAME }}
          STORAGE_ACCOUNT: ${{ env.STORAGE_ACCOUNT }}
          AZURE_STORAGE_KEY: ${{ secrets.AZURE_STORAGE_KEY }}
        run: |
          SHA_SHORT=$(echo ${{ github.sha }} | cut -c1-8)
          ACI_NAME="ci-api-$SHA_SHORT" 
          IMAGE_NAME="${{ env.ACR_LOGIN_SERVER }}/klinikops-model:${{ github.sha }}"
          CONN_STRING="DefaultEndpointsProtocol=https;AccountName=${{ env.STORAGE_ACCOUNT }};AccountKey=${{ secrets.AZURE_STORAGE_KEY }};EndpointSuffix=core.windows.net"

          az container create \
            --resource-group ${{ env.RG_NAME }} \
            --name $ACI_NAME \
            --image $IMAGE_NAME \
            --location GermanyWestCentral \
            --dns-name-label $ACI_NAME \
            --registry-login-server ${{ env.ACR_LOGIN_SERVER }} \
            --registry-username ${{ secrets.AZURE_CR_USERNAME }} \
            --registry-password ${{ secrets.AZURE_CR_PASSWORD }} \
            --ports 80 \
            --cpu 1 \
            --memory 1.5 \
            --protocol TCP \
            --os-type Linux \
            --restart-policy Always \
            --environment-variables \
              AZURE_STORAGE_ACCOUNT="${{ env.STORAGE_ACCOUNT }}" \
              AZURE_STORAGE_KEY="${{ secrets.AZURE_STORAGE_KEY }}" \
              AZURE_STORAGE_CONNECTION_STRING="$CONN_STRING"