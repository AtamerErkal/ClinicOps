name: KlinikOps Full MLOps Pipeline (CI/CD/DVC/Train/ACI/UI)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  RG_NAME: ClinicOps-RG
  LOCATION: westeurope
  STORAGE_ACCOUNT: clinicopsdvcstorage2025
  CONTAINER_NAME: clinicops-dvc
  ACR_NAME: clinicopsacr2025
  ACI_API_PREFIX: clinicops-api
  ACI_UI_NAME: clinicops-ui

jobs:
  full-mlops-workflow:
    runs-on: ubuntu-latest
    outputs:
      run_id: ${{ steps.train.outputs.MLFLOW_RUN_ID }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install dvc[azure] azure-storage-blob mlflow scikit-learn pandas

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # --- DVC Pull ---
      - name: DVC Pull Data
        env:
          AZURE_STORAGE_ACCOUNT: ${{ env.STORAGE_ACCOUNT }}
          AZURE_STORAGE_KEY: ${{ secrets.AZURE_STORAGE_KEY }}
        run: |
          dvc remote add -d myremote azure://${{ env.CONTAINER_NAME }}/data || true
          dvc remote modify myremote account_name $AZURE_STORAGE_ACCOUNT
          dvc pull -v
          ls -lh data/raw/

      # --- Train Model ---
      - name: Run Data Processing and Train Model
        id: train
        env:
          PYTHONPATH: .
          AZURE_STORAGE_ACCOUNT: ${{ env.STORAGE_ACCOUNT }}
          AZURE_STORAGE_KEY: ${{ secrets.AZURE_STORAGE_KEY }}
        run: |
          python scripts/data_processing.py
          RUN_ID=$(python scripts/train.py)
          echo "MLFLOW_RUN_ID=$RUN_ID" >> $GITHUB_OUTPUT

  deploy-api-ui:
    needs: full-mlops-workflow
    runs-on: ubuntu-latest
    environment: Production

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Docker Login
        uses: docker/login-action@v3
        with:
          registry: ${{ env.ACR_NAME }}.azurecr.io
          username: ${{ secrets.AZURE_CR_USERNAME }}
          password: ${{ secrets.AZURE_CR_PASSWORD }}

      - name: Set Deployment Variables
        id: vars
        run: |
          NEW_TAG=${{ needs.full-mlops-workflow.outputs.run_id }}
          API_NAME="${{ env.ACI_API_PREFIX }}-$NEW_TAG"
          echo "new_tag=$NEW_TAG" >> $GITHUB_OUTPUT
          echo "api_name=$API_NAME" >> $GITHUB_OUTPUT

      - name: Build and Push API Docker Image
        run: |
          docker build -t $ACR_NAME.azurecr.io/clinicops-api:${{ steps.vars.outputs.new_tag }} -f Dockerfile .
          docker push $ACR_NAME.azurecr.io/clinicops-api:${{ steps.vars.outputs.new_tag }}

      - name: Deploy New API Container
        run: |
          az container create \
            --resource-group $RG_NAME \
            --name ${{ steps.vars.outputs.api_name }} \
            --image $ACR_NAME.azurecr.io/clinicops-api:${{ steps.vars.outputs.new_tag }} \
            --registry-login-server $ACR_NAME.azurecr.io \
            --registry-username ${{ secrets.AZURE_CR_USERNAME }} \
            --registry-password ${{ secrets.AZURE_CR_PASSWORD }} \
            --ports 8000 \
            --os-type Linux \
            --restart-policy Always

      - name: Delete Old API Containers
        run: |
          ACTIVE=${{ steps.vars.outputs.api_name }}
          for ACI in $(az container list -g $RG_NAME --query "[].name" -o tsv); do
            if [ "$ACI" != "$ACTIVE" ] && [[ "$ACI" == "${{ env.ACI_API_PREFIX }}-"* ]]; then
              echo "Deleting old API: $ACI"
              az container delete -g $RG_NAME -n $ACI --yes
            fi
          done

      - name: Build and Push Streamlit UI
        run: |
          docker build -t $ACR_NAME.azurecr.io/clinicops-ui:${{ steps.vars.outputs.new_tag }} -f app/Dockerfile app
          docker push $ACR_NAME.azurecr.io/clinicops-ui:${{ steps.vars.outputs.new_tag }}

      - name: Deploy Streamlit UI
        run: |
          az container create \
            --resource-group $RG_NAME \
            --name ${{ env.ACI_UI_NAME }} \
            --image $ACR_NAME.azurecr.io/clinicops-ui:${{ steps.vars.outputs.new_tag }} \
            --registry-login-server $ACR_NAME.azurecr.io \
            --registry-username ${{ secrets.AZURE_CR_USERNAME }} \
            --registry-password ${{ secrets.AZURE_CR_PASSWORD }} \
            --ports 8501 \
            --os-type Linux \
            --restart-policy Always \
            --environment-variables CLINICOPS_API_URL=http://${{ steps.vars.outputs.api_name }}:8000

      - name: Delete Old Streamlit UI Containers
        run: |
          ACTIVE_UI=${{ env.ACI_UI_NAME }}
          for UI in $(az container list -g $RG_NAME --query "[].name" -o tsv); do
            if [ "$UI" != "$ACTIVE_UI" ] && [[ "$UI" == "${{ env.ACI_UI_NAME }}"* ]]; then
              echo "Deleting old UI: $UI"
              az container delete -g $RG_NAME -n $UI --yes
            fi
          done
