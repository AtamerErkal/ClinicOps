name: KlinikOps Full MLOps Pipeline

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  RG_NAME: ClinicOps-RG
  LOCATION: westeurope
  STORAGE_ACCOUNT: clinicopsdvcstorage2025
  CONTAINER_NAME: clinicops-dvc
  ACR_NAME: clinicopsacr2025
  ACI_API_PREFIX: clinicops-api
  ACI_UI_NAME: clinicops-ui

jobs:
  full-mlops-workflow:
    runs-on: ubuntu-latest
    outputs:
      run_id: ${{ steps.train.outputs.run_id }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install dvc[azure] azure-storage-blob

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: DVC Pull Data
        env:
          AZURE_STORAGE_ACCOUNT: ${{ env.STORAGE_ACCOUNT }}
          AZURE_STORAGE_KEY: ${{ secrets.AZURE_STORAGE_KEY }}
        run: |
          dvc remote add -d myremote azure://${{ env.CONTAINER_NAME }}/data || true
          dvc remote modify myremote account_name $AZURE_STORAGE_ACCOUNT
          dvc pull -v

      - name: Data Processing + Train Model
        id: train
        env:
          AZURE_STORAGE_ACCOUNT: ${{ env.STORAGE_ACCOUNT }}
          AZURE_STORAGE_KEY: ${{ secrets.AZURE_STORAGE_KEY }}
        run: |
          python scripts/data_processing.py
          RUN_ID=$(python scripts/train.py)
          echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT

  deploy-api-ui:
    needs: full-mlops-workflow
    runs-on: ubuntu-latest
    env:
      ACR_NAME: ${{ env.ACR_NAME }}
      ACI_API_PREFIX: ${{ env.ACI_API_PREFIX }}
      ACI_UI_NAME: ${{ env.ACI_UI_NAME }}
      RG_NAME: ${{ env.RG_NAME }}
    
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Docker Login
        uses: docker/login-action@v3
        with:
          registry: ${{ env.ACR_NAME }}.azurecr.io
          username: ${{ secrets.AZURE_CR_USERNAME }}
          password: ${{ secrets.AZURE_CR_PASSWORD }}

      - name: Build & Push API Docker
        run: |
          NEW_TAG=${{ needs.full-mlops-workflow.outputs.run_id }}
          docker build -t $ACR_NAME.azurecr.io/clinicops-api:$NEW_TAG -f Dockerfile .
          docker push $ACR_NAME.azurecr.io/clinicops-api:$NEW_TAG

      - name: Deploy New API + Delete Old APIs
        run: |
          NEW_TAG=${{ needs.full-mlops-workflow.outputs.run_id }}
          NEW_API_NAME=${ACI_API_PREFIX}-$NEW_TAG
          
          # Deploy
          az container create \
            --resource-group $RG_NAME \
            --name $NEW_API_NAME \
            --image $ACR_NAME.azurecr.io/clinicops-api:$NEW_TAG \
            --registry-login-server $ACR_NAME.azurecr.io \
            --registry-username ${{ secrets.AZURE_CR_USERNAME }} \
            --registry-password ${{ secrets.AZURE_CR_PASSWORD }} \
            --restart-policy Always \
            --os-type Linux \
            --ports 8000 \
            --environment-variables MODEL_TAG=$NEW_TAG

          # Delete old APIs
          for ACI in $(az container list -g $RG_NAME --query "[].name" -o tsv); do
            if [[ "$ACI" == ${ACI_API_PREFIX}-* ]] && [ "$ACI" != "$NEW_API_NAME" ]; then
              echo "Deleting old API: $ACI"
              az container delete -g $RG_NAME -n $ACI --yes
            fi
          done

      - name: Build & Push Streamlit UI
        run: |
          NEW_TAG=${{ needs.full-mlops-workflow.outputs.run_id }}
          docker build -t $ACR_NAME.azurecr.io/clinicops-ui:$NEW_TAG -f app/Dockerfile app
          docker push $ACR_NAME.azurecr.io/clinicops-ui:$NEW_TAG

      - name: Deploy Streamlit UI + Delete Old UI
        run: |
          NEW_TAG=${{ needs.full-mlops-workflow.outputs.run_id }}
          # Deploy new UI
          az container create \
            --resource-group $RG_NAME \
            --name $ACI_UI_NAME \
            --image $ACR_NAME.azurecr.io/clinicops-ui:$NEW_TAG \
            --registry-login-server $ACR_NAME.azurecr.io \
            --registry-username ${{ secrets.AZURE_CR_USERNAME }} \
            --registry-password ${{ secrets.AZURE_CR_PASSWORD }} \
            --restart-policy Always \
            --os-type Linux \
            --ports 8501 \
            --environment-variables CLINICOPS_API_TAG=$NEW_TAG \
            || az container restart -g $RG_NAME -n $ACI_UI_NAME
