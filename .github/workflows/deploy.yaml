name: KlinikOps Full MLOps Pipeline (CI/CD/DVC/ACI)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  RG_NAME: ClinicOps-RG
  # ‚ö†Ô∏è KRƒ∞Tƒ∞K: Storage ile aynƒ± region kullan!
  LOCATION: germanywestcentral  # Germany West ile uyumlu
  STORAGE_ACCOUNT: clinicopsdvcstorage2025
  CONTAINER_NAME: clinicops-dvc
  ACR_LOGIN_SERVER: ${{ secrets.AZURE_CR_LOGIN_SERVER }}
  ACR_USERNAME: ${{ secrets.AZURE_CR_USERNAME }}
  ACR_PASSWORD: ${{ secrets.AZURE_CR_PASSWORD }}
  ACI_API_PREFIX: clinicops-api
  ACI_UI_NAME: clinicops-ui
  AZURE_STORAGE_CONNECTION_STRING: ${{ secrets.AZURE_STORAGE_CONNECTION_STRING }}

jobs:
  full-mlops-workflow:
    runs-on: ubuntu-latest
    outputs:
      run_id: ${{ steps.train.outputs.MLFLOW_RUN_ID }}
      
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # --- DVC PULL DATA ---
      - name: DVC Pull Data
        env:
          AZURE_STORAGE_ACCOUNT: ${{ env.STORAGE_ACCOUNT }}
          AZURE_STORAGE_KEY: ${{ secrets.AZURE_STORAGE_KEY }}
        run: |
          dvc remote add -d myremote azure://${{ env.CONTAINER_NAME }}/data || true
          dvc remote modify myremote account_name $AZURE_STORAGE_ACCOUNT
          dvc pull -v

            # --- DATA PROCESSING + TRAIN ---
      - name: Run Data Processing and Train Model
        id: train
        env:
          PYTHONPATH: .
          AZURE_STORAGE_ACCOUNT: ${{ env.STORAGE_ACCOUNT }}
          AZURE_STORAGE_KEY: ${{ secrets.AZURE_STORAGE_KEY }}
          AZURE_STORAGE_CONNECTION_STRING: ${{ secrets.AZURE_STORAGE_CONNECTION_STRING }}
        run: |
          python scripts/data_processing.py
          # Run training and capture ALL output
          echo "üöÄ Starting model training..."
          python scripts/train.py > train_output.txt 2>&1
          # Show output for debugging
          echo "=== Training Output ==="
          cat train_output.txt
          echo "======================="
          # Extract Run ID - multiple fallback patterns
          RUN_ID=$(grep "Run ID:" train_output.txt | tail -1 | sed 's/.*Run ID: //' | tr -d '[:space:]')
          # Fallback 1: Try UUID pattern (32 hex chars)
          if [ -z "$RUN_ID" ]; then
            echo "‚ö†Ô∏è First pattern failed, trying UUID pattern..."
            RUN_ID=$(grep -oE '[a-f0-9]{32}' train_output.txt | tail -1)
          fi
          # Fallback 2: Try MLflow run_id pattern
          if [ -z "$RUN_ID" ]; then
            echo "‚ö†Ô∏è UUID failed, trying 'run_id=' pattern..."
            RUN_ID=$(grep -i "run_id" train_output.txt | grep -oE '[a-f0-9]{32}' | tail -1)
          fi
          # Fallback 3: Try any 32-char hex string
          if [ -z "$RUN_ID" ]; then
            echo "‚ö†Ô∏è All patterns failed, trying any 32-hex..."
            RUN_ID=$(grep -oE '[a-f0-9]{32}' train_output.txt | head -1)
          fi
          # Verify we got something
          if [ -z "$RUN_ID" ]; then
            echo "‚ùå ERROR: Could not extract Run ID! Check train.py output above."
            echo "MLFLOW_RUN_ID=fallback_error" >> $GITHUB_OUTPUT
            exit 1  # Fail if no ID (model yok)
          fi
          echo "‚úÖ Extracted Run ID: $RUN_ID"
          echo "MLFLOW_RUN_ID=$RUN_ID" >> $GITHUB_OUTPUT

  deploy-api-to-aci:
    needs: full-mlops-workflow
    runs-on: ubuntu-latest
    environment: Production
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Verify Run ID
        run: |
          RUN_ID="${{ needs.full-mlops-workflow.outputs.run_id }}"
          echo "üì¶ Run ID from training: $RUN_ID"
          
          if [ -z "$RUN_ID" ]; then
            echo "‚ùå ERROR: Run ID is empty!"
            exit 1
          fi
          
          # Validate format (32 hex chars)
          if ! echo "$RUN_ID" | grep -qE '^[a-f0-9]{32}$'; then
            echo "‚ö†Ô∏è WARNING: Run ID format looks unusual: $RUN_ID"
          else
            echo "‚úÖ Run ID format validated"
          fi

      - name: Docker Login
        uses: docker/login-action@v3
        with:
          registry: ${{ env.ACR_LOGIN_SERVER }}
          username: ${{ env.ACR_USERNAME }}
          password: ${{ env.ACR_PASSWORD }}

      # --- BUILD + PUSH API IMAGE ---
      - name: Build and Push API Docker Image
        id: build_and_push
        run: |
          NEW_TAG=$(date +'%Y%m%d%H%M%S')
          IMAGE_NAME=${{ env.ACR_LOGIN_SERVER }}/clinicops-api:$NEW_TAG
          
          echo "üê≥ Building API image: $IMAGE_NAME"
          docker build -t $IMAGE_NAME -f Dockerfile .
          docker push $IMAGE_NAME
          
          echo "NEW_TAG=$NEW_TAG" >> $GITHUB_OUTPUT
          echo "IMAGE_NAME=$IMAGE_NAME" >> $GITHUB_OUTPUT

      # --- DELETE OLD API CONTAINERS FIRST ---
      - name: Delete Old API Containers
        run: |
          echo "üóëÔ∏è Cleaning up old API containers..."
          for ACI in $(az container list -g ${{ env.RG_NAME }} --query "[?starts_with(name, '${{ env.ACI_API_PREFIX }}-')].name" -o tsv); do
            echo "Deleting: $ACI"
            az container delete -g ${{ env.RG_NAME }} -n $ACI --yes || echo "Failed to delete $ACI"
          done

      # --- DEPLOY NEW ACI API ---
      - name: Deploy API to ACI
        run: |
          NEW_TAG="${{ steps.build_and_push.outputs.NEW_TAG }}"
          ACI_NAME="${{ env.ACI_API_PREFIX }}-${NEW_TAG}"
          RUN_ID="${{ needs.full-mlops-workflow.outputs.run_id }}"
          
          echo "üöÄ Deploying API container: $ACI_NAME"
          echo "üì¶ Using Model Run ID: $RUN_ID"
          echo "üåç Location: ${{ env.LOCATION }}"
          
          az container create \
            --resource-group ${{ env.RG_NAME }} \
            --name $ACI_NAME \
            --image ${{ steps.build_and_push.outputs.IMAGE_NAME }} \
            --dns-name-label $ACI_NAME \
            --registry-login-server ${{ env.ACR_LOGIN_SERVER }} \
            --registry-username ${{ env.ACR_USERNAME }} \
            --registry-password ${{ env.ACR_PASSWORD }} \
            --ports 8000 \
            --cpu 1 \
            --memory 2 \
            --os-type Linux \
            --restart-policy Always \
            --location ${{ env.LOCATION }} \
            --environment-variables \
              MLFLOW_RUN_ID="$RUN_ID" \
              AZURE_STORAGE_ACCOUNT="${{ env.STORAGE_ACCOUNT }}" \
              AZURE_STORAGE_CONNECTION_STRING="${{ secrets.AZURE_STORAGE_CONNECTION_STRING }}" \
              AZURE_STORAGE_KEY="${{ secrets.AZURE_STORAGE_KEY }}" \
              AZURE_SUBSCRIPTION_ID="${{ secrets.AZURE_SUBSCRIPTION_ID }}" \
              CONTAINER_NAME="${{ env.CONTAINER_NAME }}" \
              RG_NAME="${{ env.RG_NAME }}" \
              LOCATION="${{ env.LOCATION }}"
          
          echo "‚úÖ API deployed successfully"
          
          # Wait for container to be ready
          echo "‚è≥ Waiting for container to start..."
          sleep 30
          
          # Get FQDN and test health endpoint
          FQDN=$(az container show -g ${{ env.RG_NAME }} -n $ACI_NAME --query ipAddress.fqdn -o tsv)
          echo "üåê API URL: http://${FQDN}:8000"
          
          # Test health endpoint (with retry)
          for i in {1..5}; do
            echo "Health check attempt $i/5..."
            if curl -f "http://${FQDN}:8000/health" 2>/dev/null; then
              echo "‚úÖ API is healthy!"
              break
            else
              echo "‚ö†Ô∏è Health check failed, retrying in 15s..."
              sleep 15
            fi
          done

      # --- BUILD & DEPLOY UI ---
      - name: Build and Push UI Docker Image
        id: build_ui
        run: |
          NEW_TAG="${{ steps.build_and_push.outputs.NEW_TAG }}"
          UI_IMAGE=${{ env.ACR_LOGIN_SERVER }}/clinicops-ui:$NEW_TAG
          
          echo "üê≥ Building UI image: $UI_IMAGE"
          cd app
          docker build -t $UI_IMAGE -f Dockerfile .
          cd ..
          docker push $UI_IMAGE
          
          echo "UI_IMAGE=$UI_IMAGE" >> $GITHUB_OUTPUT

      - name: Delete Old UI Container
        run: |
          echo "üóëÔ∏è Deleting old UI container..."
          az container delete \
            -g ${{ env.RG_NAME }} \
            -n ${{ env.ACI_UI_NAME }} \
            --yes || echo "No existing UI to delete"

      - name: Deploy UI to ACI
        run: |
          NEW_TAG="${{ steps.build_and_push.outputs.NEW_TAG }}"
          UI_IMAGE="${{ steps.build_ui.outputs.UI_IMAGE }}"
          API_FQDN="${{ env.ACI_API_PREFIX }}-${NEW_TAG}.${{ env.LOCATION }}.azurecontainer.io"
          
          echo "üöÄ Deploying UI container"
          echo "üîó API URL: http://${API_FQDN}:8000"
          
          az container create \
            --resource-group ${{ env.RG_NAME }} \
            --name ${{ env.ACI_UI_NAME }} \
            --image $UI_IMAGE \
            --dns-name-label ${{ env.ACI_UI_NAME }}-${NEW_TAG} \
            --registry-login-server ${{ env.ACR_LOGIN_SERVER }} \
            --registry-username ${{ env.ACR_USERNAME }} \
            --registry-password ${{ env.ACR_PASSWORD }} \
            --ports 8501 \
            --cpu 1 \
            --memory 1.5 \
            --os-type Linux \
            --restart-policy Always \
            --location ${{ env.LOCATION }} \
            --environment-variables CLINICOPS_API_URL="http://${API_FQDN}:8000"
          
          # Get UI FQDN
          UI_FQDN=$(az container show -g ${{ env.RG_NAME }} -n ${{ env.ACI_UI_NAME }} --query ipAddress.fqdn -o tsv)
          
          echo ""
          echo "=========================================="
          echo "‚úÖ DEPLOYMENT COMPLETE!"
          echo "=========================================="
          echo "üåê API:  http://${API_FQDN}:8000/health"
          echo "üåê UI:   http://${UI_FQDN}:8501"
          echo "=========================================="