name: KlinikOps Full MLOps Pipeline (CI/CD/DVC/ACI)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  RG_NAME: ClinicOps-RG
  LOCATION: westeurope
  STORAGE_ACCOUNT: clinicopsdvcstorage2025
  CONTAINER_NAME: clinicops-dvc
  ACR_LOGIN_SERVER: ${{ secrets.AZURE_CR_LOGIN_SERVER }}
  ACR_USERNAME: ${{ secrets.AZURE_CR_USERNAME }}
  ACR_PASSWORD: ${{ secrets.AZURE_CR_PASSWORD }}
  ACI_API_PREFIX: clinicops-api
  ACI_UI_NAME: clinicops-ui
  AZURE_STORAGE_CONNECTION_STRING: ${{ secrets.AZURE_STORAGE_CONNECTION_STRING }}

jobs:
  full-mlops-workflow:
    runs-on: ubuntu-latest
    outputs:
      run_id: ${{ steps.train.outputs.MLFLOW_RUN_ID }}
      
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install dvc[azure] azure-storage-blob mlflow scikit-learn pandas

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # --- DVC PULL DATA ---
      - name: DVC Pull Data
        env:
          AZURE_STORAGE_ACCOUNT: ${{ env.STORAGE_ACCOUNT }}
          AZURE_STORAGE_KEY: ${{ secrets.AZURE_STORAGE_KEY }}
        run: |
          dvc remote add -d myremote azure://${{ env.CONTAINER_NAME }}/data || true
          dvc remote modify myremote account_name $AZURE_STORAGE_ACCOUNT
          dvc pull -v

      # --- DATA PROCESSING + TRAIN ---
      - name: Run Data Processing and Train Model
        id: train
        env:
          PYTHONPATH: .
          AZURE_STORAGE_ACCOUNT: ${{ env.STORAGE_ACCOUNT }}
          AZURE_STORAGE_KEY: ${{ secrets.AZURE_STORAGE_KEY }}
          AZURE_STORAGE_CONNECTION_STRING: ${{ secrets.AZURE_STORAGE_CONNECTION_STRING }}
        run: |
          python scripts/data_processing.py
          # RUN_ID'yi temizle: Sadece "Run ID:" içeren satırı al, ID'yi extract et
          RUN_ID=$(python scripts/train.py 2>&1 | grep "Run ID:" | tail -1 | sed 's/.*Run ID: //')
          echo "MLFLOW_RUN_ID=$RUN_ID" >> $GITHUB_OUTPUT

  deploy-api-to-aci:
    needs: full-mlops-workflow
    runs-on: ubuntu-latest
    environment: Production
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Docker Login
        uses: docker/login-action@v3
        with:
          registry: ${{ env.ACR_LOGIN_SERVER }}
          username: ${{ env.ACR_USERNAME }}
          password: ${{ env.ACR_PASSWORD }}

      # --- BUILD + PUSH API IMAGE ---
      - name: Build and Push API Docker Image
        id: build_and_push
        run: |
          NEW_TAG=$(date +'%Y%m%d%H%M%S')
          IMAGE_NAME=${{ env.ACR_LOGIN_SERVER }}/clinicops-api:$NEW_TAG
          docker build -t $IMAGE_NAME -f Dockerfile .
          docker push $IMAGE_NAME
          echo "NEW_TAG=$NEW_TAG" >> $GITHUB_OUTPUT
          echo "IMAGE_NAME=$IMAGE_NAME" >> $GITHUB_OUTPUT

      # --- DEPLOY NEW ACI API & DELETE OLD ---
      - name: Deploy API to ACI
        run: |
          ACI_NAME="${{ env.ACI_API_PREFIX }}-${{ steps.build_and_push.outputs.NEW_TAG }}"
          echo "Deploying container: $ACI_NAME"
          az container create \
            --resource-group ${{ env.RG_NAME }} \
            --name $ACI_NAME \
            --image ${{ steps.build_and_push.outputs.IMAGE_NAME }} \
            --dns-name-label $ACI_NAME \
            --registry-login-server ${{ env.ACR_LOGIN_SERVER }} \
            --registry-username ${{ env.ACR_USERNAME }} \
            --registry-password ${{ env.ACR_PASSWORD }} \
            --ports 8000 \
            --cpu 1 \
            --memory 1.5 \
            --os-type Linux \
            --restart-policy Always \
            --location ${{ env.LOCATION }} \
            --environment-variables MLFLOW_RUN_ID=${{ needs.full-mlops-workflow.outputs.run_id }} AZURE_STORAGE_ACCOUNT=${{ env.STORAGE_ACCOUNT }} AZURE_STORAGE_CONNECTION_STRING=${{ secrets.AZURE_STORAGE_CONNECTION_STRING }} AZURE_STORAGE_KEY=${{ secrets.AZURE_STORAGE_KEY }} RG_NAME=${{ env.RG_NAME }} LOCATION=${{ env.LOCATION }}

          # Delete old API containers
          ACTIVE=$ACI_NAME
          for ACI in $(az container list -g ${{ env.RG_NAME }} --query "[].name" -o tsv); do
            if [ "$ACI" != "$ACTIVE" ] && [[ "$ACI" == "${{ env.ACI_API_PREFIX }}-"* ]]; then
              echo "Deleting old API: $ACI"
              az container delete -g ${{ env.RG_NAME }} -n $ACI --yes
            fi
          done

# --- DEPLOY STREAMLIT UI ---
      - name: Build & Deploy Streamlit UI
        run: |
          NEW_TAG="${{ steps.build_and_push.outputs.NEW_TAG }}"
          UI_IMAGE=${{ env.ACR_LOGIN_SERVER }}/clinicops-ui:$NEW_TAG
          cd app && docker build -t $UI_IMAGE .
          cd .. && docker push $UI_IMAGE
          ACI_FQDN="${{ env.ACI_API_PREFIX }}-${NEW_TAG}.${{ env.LOCATION }}.azurecontainer.io"
          # ACI create (os-type explicit = ile, hata handling)
          az container create \
            --resource-group ${{ env.RG_NAME }} \
            --name ${{ env.ACI_UI_NAME }} \
            --image $UI_IMAGE \
            --dns-name-label ${{ env.ACI_UI_NAME }}-${NEW_TAG} \
            --registry-login-server ${{ env.ACR_LOGIN_SERVER }} \
            --registry-username ${{ env.ACR_USERNAME }} \
            --registry-password ${{ env.ACR_PASSWORD }} \
            --ports 8501 \
            --cpu 1 \
            --memory 1.5 \
            --os-type=Linux \
            --restart-policy Always \
            --location ${{ env.LOCATION }} \
            --environment-variables CLINICOPS_API_URL=http://${ACI_FQDN}:8000 \
            || echo "Create failed, trying restart..." && az container restart -g ${{ env.RG_NAME }} -n ${{ env.ACI_UI_NAME }} || echo "Restart also failed - check logs"